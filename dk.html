<html>
    <head>
        <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
        <style>
            canvas {
                border:1px solid #ffffff;
                background-color: #000000;
            }
        </style>
    </head>
    <body onload="startGame()">
        <script>
            var jumpman;
            var dkScenario;
            var jumpmanSpriteSheet = "images/sprites/jumpmanSpriteSheet.png"
            var background = "images/bg/dkBackground.png";
            var direction = true;
            var colisionMatrix = [];
            var posY = 0,baseY = 0;

            for(var i = 0; i < 6; i++){
                colisionMatrix[i] = [];
                for(var j = 0; j < 10; j++)
                    colisionMatrix[i][j] = {};
            }

            for(var column = 0; column < 10; column++){
                if(column > 4){
                    baseY += 3;
                }

                if(column < 9){
                    colisionMatrix[0][column].beam = 161+baseY;
                    colisionMatrix[2][column].beam = 302+posY;
                    colisionMatrix[4][column].beam = 451+posY;
                }

                if(column > 0){
                    colisionMatrix[1][column].beam = 248-posY;
                    colisionMatrix[3][column].beam = 398-posY;
                }

                colisionMatrix[5][column].beam = 541-baseY; 
                posY += 2;
            }

            function startGame() {
                jumpman = new character(37, 40, jumpmanSpriteSheet, 203, 100,"image");
                dkScenario = new scenario();
                dkScenario.start();
            }

            function scenario(){
                this.canvas = document.createElement("canvas");
                this.image = new Image();
                this.image.src = background;

                this.start = function() {
                    this.canvas.width = 800;
                    this.canvas.height = 600;
                    this.context = this.canvas.getContext("2d");
                    document.body.insertBefore(this.canvas, document.body.childNodes[0]);
                    this.interval = setInterval(updateGameArea, 1000/30);

                    window.addEventListener('keydown', function (e) {
                        dkScenario.keys = (dkScenario.keys || []);
                        if(e.repeat && e.keyCode == 38){
                            dkScenario.keys[e.keyCode] = (e.type == null);
                        }
                        else{
                            dkScenario.keys[e.keyCode] = (e.type == "keydown");
                        }
                    })
                    window.addEventListener('keyup', function (e) {
                        dkScenario.keys[e.keyCode] = (e.type == "keydown");        
                    })
                }

                this.clear = function(){
                    this.context.clearRect(0, 0, this.canvas.width, this.canvas.height);
                }

                this.updateBackground = function(){
                    ctx = dkScenario.context;
                    ctx.drawImage(this.image,0,0,800,600,0,0,800,600);
                    
                    /*for(var i = 0; i < 10; i++){
                        for(var j = 0; j < 6; j++){
                                ctx.beginPath();
                                ctx.strokeStyle = "yellow";
                                ctx.rect(100 + (i*60), 110 + (j*73), 60, 73);
                                ctx.stroke();
                        }
                    }*/
                }
            }

            function character(width, height, color, x, y,type) {
   
                var jumpspeed = 0;

                this.i = 0; 
                this.j = 0; 
                this.k = 0;

                this.floor = 0;

                this.image = new Image();
                this.image.src = color;

                this.gamearea = dkScenario;
                this.width = width;
                this.height = height;
                this.speedX = 0;
                this.speedY = 0;    
                this.x = x;
                this.y = y;

                this.jump = 0;

                this.gravity = 0.35;
                this.gravitySpeed = 0;

                this.update = function() {
                    ctx = dkScenario.context;
                    ctx.drawImage(this.image,this.i*256,this.j*256,256,256,this.x,this.y,this.width,this.height);
                }

                this.newPos = function() {

                    var posX,posY;

                    posY = this.y+jumpman.height - 110;
                    posX = this.x - 100 + (this.width/2);

                    line = Math.floor(((posY)/438)*6);
                    column = Math.floor(((posX)/600)*10);

                    if(column == 0 && (line == 0 || line == 2 || line == 4) && posX < 30){
                        this.floor = undefined;
                    }
                    else if(column == 9 && (line == 1 || line == 3) && posX > 570){
                        this.floor = undefined;
                    }
                    else{
                        this.floor = colisionMatrix[line][column].beam;
                    }

                    if ((this.y + this.speedY < this.floor-jumpman.height && this.y + this.speedY > 0) || this.floor == undefined) {
                  
                        this.gravitySpeed += this.gravity;
                        this.y += this.speedY + this.gravitySpeed;
                        if(this.jump != 1)
                            this.jump = 2;

                        updateSprite(2,false);
                        this.hitBottom();
                    }
                    if (this.x + jumpman.width + this.speedX < 710 && this.x + this.speedX > 90) {
                        if(this.jump == 0){
                            this.x += this.speedX;
                            jumpspeed = this.speedX;
                            this.hitBottom();
                        }
                        else if(this.jump == 1 || this.floor != undefined){
                            if(this.x + this.width > 700){
                                jumpspeed = jumpspeed*(-1);
                                updateSprite(1,true);
                            }
                            else if(this.x < 100){
                                jumpspeed = jumpspeed*(-1);
                                updateSprite(0,true);
                            }
                            this.x += jumpspeed;
                        }
                        else{
                            jumpspeed = 0;
                        }
                    }
                } 
                
                this.hitBottom = function() {
                    var rockbottom = this.floor - this.height;

                    if (this.y  > rockbottom) {
                        this.y = rockbottom;
                        this.gravitySpeed = 0;
                        this.jump = 0;
                        updateSprite(2,false);
                    }
                }   
            }

            function updateGameArea() {

                dkScenario.clear();
                dkScenario.updateBackground();
                jumpman.speedX = 0;

                if (jumpman.y == jumpman.floor - jumpman.height)
                    jumpman.speedY = 0;

                if (dkScenario.keys && dkScenario.keys[37] && !jumpman.jump) {jumpman.speedX = -3; updateSprite(1,true)}
                if (dkScenario.keys && dkScenario.keys[39] && !jumpman.jump){jumpman.speedX = 3; updateSprite(0,true)}
                if (dkScenario.keys && dkScenario.keys[38]) {jumpman.speedY = -5; updateSprite(2,false);jumpman.jump = true}
                jumpman.newPos();    
                jumpman.update();
            }
            
            function updateSprite(left,turn){    

                if(turn){
                    if(left == 0){
                        jumpman.j = 0;
                        direction = true;
                    }
                    else if(left == 1){
                        jumpman.j = 1;
                        direction = false;
                    }
                }

                if(!jumpman.jump){
                    jumpman.i++;

                    if(jumpman.i>2)
                        jumpman.i = 0;
                }
                else{
                    jumpman.i = 3;
                }
            }
        </script>
    </body>
</html>
